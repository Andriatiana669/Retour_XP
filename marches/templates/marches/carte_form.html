{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ titre }} carte – {{ marche.nom_marche }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'marches/css/carte_form.css' %}">
<style>
  .clients-checkboxes {
    display: flex;
    flex-direction: column;
    gap: .5rem
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: .4rem
  }

  .demarche-fields {
    display: none;
    margin-top: 1rem
  }
</style>
{% endblock %}

{% block content %}
<section class="form-hero">
  <h1><i class="fas fa-layer-group"></i> {{ titre }} une carte</h1>
  <p class="breadcrumb">
    <a href="{% url 'dashboard:dashboard' %}">Dashboard</a> /
    <a href="{% url 'marches:description' marche.id %}">{{ marche.nom_marche }}</a> /
    {{ titre }} carte
  </p>
</section>

<form method="post" enctype="multipart/form-data" class="glass-form" id="carteForm">
  {% csrf_token %}

  <!-- 1. Titre -->
  <div class="field-box">
    <label for="id_titre">Titre</label>
    {{ form.titre }}
    {% if form.titre.errors %}<small class="error">{{ form.titre.errors|first }}</small>{% endif %}
  </div>

  <!-- 2. Objet -->
  <div class="field-box">
    <label for="id_objet">Objet</label>
    {{ form.objet }}
    {% if form.objet.errors %}<small class="error">{{ form.objet.errors|first }}</small>{% endif %}
  </div>

  <!-- 3. Contenu -->
  <div class="field-box">
    <label for="id_contenu">Contenu</label>
    {{ form.contenu }}
    {% if form.contenu.errors %}<small class="error">{{ form.contenu.errors|first }}</small>{% endif %}
  </div>

  <!-- 4. Image -->
  <div class="field-box">
    <label for="id_image">Image</label>
    {{ form.image }}
    {% if form.image.errors %}<small class="error">{{ form.image.errors|first }}</small>{% endif %}
  </div>

  <!-- 5. Date retour (calendrier natif) -->
  <div class="field-box">
    <label for="id_date_retour">Date retour</label>
    <input type="date" name="date_retour" id="id_date_retour"
      value="{% if form.date_retour.value %}{{ form.date_retour.value|date:'Y-m-d' }}{% endif %}" required>
    {% if form.date_retour.errors %}<small class="error">{{ form.date_retour.errors|first }}</small>{% endif %}
  </div>

  <!-- 6. Solution -->
  <div class="field-box">
    <label for="id_solution">Solution</label>
    {{ form.solution }}
    {% if form.solution.errors %}<small class="error">{{ form.solution.errors|first }}</small>{% endif %}
  </div>

  <!-- 7-9. Champs démarche (affichés dynamiquement) -->
  <div class="demarche-fields" id="demarcheFields">
    {% for field in form.demarche_solution %}
      <div class="field-box">
        {{ field.label_tag }}
        {{ field }}
        {% if field.errors %}<small class="error">{{ field.errors|first }}</small>{% endif %}
      </div>
    {% endfor %}

    {% for field in form.nom_dossier %}
      <div class="field-box">
        <label for="id_nom_dossier">Nom dossier</label>
        {{ field.label_tag }}
        {{ field }}
        {% if field.errors %}<small class="error">{{ field.errors|first }}</small>{% endif %}
      </div>
    {% endfor %}

    {% for field in form.date_livraison %}
        <div class="field-box">
          <label for="{{ form.date_livraison.id_for_label }}">Date livraison</label>
          <input type="date"
                name="{{ form.date_livraison.html_name }}"
                id="{{ form.date_livraison.id_for_label }}"
                value="{% if form.date_livraison.value %}{{ form.date_livraison.value|date:'Y-m-d' }}{% endif %}"
                {% if form.date_livraison.field.required %}required{% endif %}>
          {% if form.date_livraison.errors %}<small class="error">{{ form.date_livraison.errors|first }}</small>{% endif %}
        </div>
    {% endfor %}
  </div>


  <!-- Clients du marché -->
  <div class="field-box">
    <label>Client(s) lié(s) au marché</label>
    <div class="clients-checkboxes">
      {% for client in clients_marche %}
        <label class="checkbox-item">
          <input type="checkbox" name="clients_choisis" value="{{ client.id }}"
               {% if client.id == selected_client or clients_marche|length == 1 %}checked{% endif %}>
          {{ client.nom }}
        </label>
      {% empty %}
        <p class="text-muted">Aucun client défini pour ce marché.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Boutons -->
  <div class="actions">
    <a href="{% url 'marches:description' marche.id %}" class="btn-cancel">Annuler</a>
    <button type="submit" class="btn-save"><i class="fas fa-save"></i> Enregistrer</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
  const solutionSelect = document.querySelector('#id_solution');
  const demarcheDiv = document.querySelector('#demarcheFields');

  function toggleDemarche() {
    const selected = solutionSelect.options[solutionSelect.selectedIndex];
    const need = selected && selected.dataset.demande === 'True';
    demarcheDiv.style.display = need ? 'block' : 'none';
  }

  // injection data-attribute côté serveur
  {% for sol in form.solution.field.queryset %}
  solutionSelect.querySelector('option[value="{{ sol.id }}"]').dataset.demande = '{{ sol.demande_demarche|yesno:"True,False" }}';
  {% endfor %}

  solutionSelect.addEventListener('change', toggleDemarche);
  document.addEventListener('DOMContentLoaded', toggleDemarche);
</script>
{% endblock %}