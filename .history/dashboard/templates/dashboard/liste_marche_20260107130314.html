<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste des Marchés - {{ marche_global.nom }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard/css/liste_marche.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- petite surcouche pour les boutons d'action -->
    <style>
        .actions-cell{display:flex;gap:.4rem;}
        .actions-cell .btn-voir{padding:.3rem .6rem;font-size:.8rem;}
        .etat-select{max-width:160px;font-size:.85rem;}
        .save-etat-btn{background:var(--success-color);color:#fff;border:none;
                       padding:.25rem .5rem;border-radius:.25rem;font-size:.8rem;cursor:pointer;}
        .center-buttons{display:flex;justify-content:center;gap:1rem;margin:2rem 0;}
    </style>
</head>
<body>
<header>
    <h1><i class="fas fa-list-ul me-2"></i>{{ marche_global.nom }}</h1>
    <nav>
        <a href="{% url 'dashboard:dashboard' %}"><i class="fas fa-arrow-left me-1"></i>Retour</a>
        <a href="{% url 'authentification:logout' %}"><i class="fas fa-sign-out-alt me-1"></i>Déconnexion</a>
    </nav>
</header>

<main>
<h2><i class="fas fa-table me-2" style="color: #0d6efd;"></i>
    <span style="color: #0d6efd;">Liste des Marchés Détaillés</span></h2>

<table class="marches-table">
    <thead>
    <tr>
        <th><i class="fas fa-calendar-alt me-1"></i> Date de MAJ</th>
        <th><i class="fas fa-tasks me-1"></i> État Affaire</th>
        <th><i class="fas fa-shopping-cart me-1"></i> Marché</th>
        <th><i class="fas fa-user-tie me-1"></i> Resp Projet</th>
        <th><i class="fas fa-cogs me-1"></i> Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for marche in marches_detailles %}
    <tr data-id="{{ marche.id }}">
        <td>{{ marche.date_maj|date:"d/m/Y H:i" }}</td>

        <!-- État modifiable directement -->
        <td>
            <form class="etat-inline" style="display:flex;gap:.3rem;align-items:center;">
                {% csrf_token %}
                <select name="etat" class="etat-select">
                    <option value="">– Non défini –</option>
                    {% for etat in etats %}
                    <option value="{{ etat.id }}"
                        {% if marche.etat_affaire.id == etat.id %}selected{% endif %}
                        style="color:{{ etat.couleur }};background:{{ etat.couleur_fond }}">
                        {{ etat.nom }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="save-etat-btn" title="Enregistrer">
                    <i class="fas fa-check"></i>
                </button>
            </form>
        </td>

        <td>{{ marche.nom_marche }}</td>
        <td>{{ marche.resp_marche }}</td>

        <!-- 3 boutons d'action -->
        <td>
            <div class="actions-cell">
                <a href="{% url 'marches:description' marche.id %}" class="btn-voir">
                    <i class="fas fa-eye"></i> Voir
                </a>
                <a href="{% url 'dashboard:modifier_marche' marche.id %}" class="btn-voir" style="background:var(--secondary-color);">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <a href="{% url 'dashboard:supprimer_marche' marche.id %}" class="btn-voir" style="background:var(--danger-color);"
                   onclick="return confirm('Supprimer ce marché ?');">
                    <i class="fas fa-trash"></i> Supprimer
                </a>
            </div>
        </td>
    </tr>
    {% empty %}
    <tr><td colspan="5" class="text-center">Aucun marché détaillé trouvé.</td></tr>
    {% endfor %}
    </tbody>
</table>

<!-- Boutons centrés -->
<div class="center-buttons">
    <a href="{% url 'dashboard:ajouter_marche' marche_global.id %}" class="btn-voir">
        <i class="fas fa-plus-circle"></i> Ajouter un marché détaillé
    </a>
    <a id="saveAllEtats" class="btn-voir" style="background:var(--success-color);">
        <i class="fas fa-save"></i> Enregistrer
    </a>
</div>
</main>

<script src="{% static 'dashboard/js/liste_marche.js' %}"></script>
</body>
</html>