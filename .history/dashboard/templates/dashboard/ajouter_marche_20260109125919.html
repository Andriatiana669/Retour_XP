{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}Ajouter – {{ marche_global.nom }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/ajouter_marche.css' %}">
<style>
/* Recherche rapide dans les select multiples */
.select-search {
    width: 100%;
    padding: 0.25rem;
    margin-bottom: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<div class="form-wrapper">
    <h2><i class="fas fa-plus-circle"></i> Ajouter un marché dans « {{ marche_global.nom }} »</h2>

    <form method="post" class="form-body">
        {% csrf_token %}

        {% for field in form %}
            {% if field.name not in 'matricule titre description objet date_retour' %}
            <div class="form-group">
                {{ field.label_tag }}

                {% if field.field.widget|yesno:"True,False" == "True" and field.field.widget.attrs.class != "django-select2" %}
                    {# Ajoute recherche pour les select multiples #}
                    <input type="text" class="select-search" placeholder="Rechercher...">
                {% endif %}

                {{ field }}

                {% if field.help_text %}
                <small class="form-text text-muted">{{ field.help_text }}</small>
                {% endif %}
                {% if field.errors %}
                <small class="error-text">{{ field.errors|join:', ' }}</small>
                {% endif %}
            </div>
            {% endif %}
        {% endfor %}

        <div class="form-actions">
            <button type="submit" class="btn-voir save">
                <i class="fas fa-save"></i> Enregistrer
            </button>
            <a href="{% url 'dashboard:liste_marche' marche_global.id %}" class="btn-voir secondary">
                Annuler
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Filtre rapide pour les select multiples (responsables, prestations, clients)
    document.querySelectorAll('.select-search').forEach(input => {
        const select = input.nextElementSibling;
        if (!select || select.tagName !== 'SELECT') return;
        input.addEventListener('input', () => {
            const val = input.value.toLowerCase();
            [...select.options].forEach(opt => {
                opt.style.display = opt.text.toLowerCase().includes(val) ? '' : 'none';
            });
        });
    });
});
</script>
{% endblock %}
