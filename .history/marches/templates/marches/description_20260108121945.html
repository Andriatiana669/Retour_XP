{% extends 'dashboard/base.html' %}
{% load static %}
{% block title %}{{ marche_detaille.titre }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'marches/css/description.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<main class="container">
  <!-- Bloc infos -->
  <section class="info-grid">
    <div class="info-card">
      <div class="info-header">
        <span class="etat-item">
          <i class="fas fa-tag"></i>
          <strong>Statut :</strong> {{ marche_detaille.etat_affaire.nom|default:'Non défini' }}
        </span>
        <span class="maj-item">
          <i class="far fa-clock"></i>
          <strong>MAJ :</strong> {{ marche_detaille.date_maj|date:"d/m/Y H:i" }}
        </span>
      </div>
      <div class="info-items-container">
        <div class="info-item"><i class="fas fa-barcode"></i><span><strong>Matricule</strong><br>{{ marche_detaille.matricule }}</span></div>
        <div class="info-item"><i class="fas fa-shopping-cart"></i><span><strong>Marché</strong><br>{{ marche_detaille.nom_marche }}</span></div>
        <div class="info-item"><i class="fas fa-user-tie"></i><span><strong>Responsable</strong><br>{{ marche_detaille.resp_marche }}</span></div>
        <div class="info-item"><i class="fas fa-calendar-check"></i><span><strong>Retour</strong><br>{{ marche_detaille.date_retour|default:'Non planifié' }}</span></div>
      </div>
    </div>
    {% if marche_detaille.description %}
    <div class="description-box">
      <h3><i class="fas fa-info-circle"></i> Description</h3>
      <p>{{ marche_detaille.description|linebreaks }}</p>
    </div>
    {% endif %}
  </section>

  <!-- ========== CARTES ========== -->
  <section class="cartes-section">
    <div class="cartes-header">
      <h2><i class="fas fa-layer-group"></i> Cartes</h2>
      <div class="view-toggle">
        <button id="btnGrand" class="vue-btn active" title="Grandes cartes"><i class="fas fa-th-large"></i></button>
        <button id="btnPetit" class="vue-btn" title="Petites cartes"><i class="fas fa-list"></i></button>
      </div>
      {% if request.user.profile.est_responsable %}
      <a href="{% url 'marches:ajouter_carte' marche_detaille.id %}" class="btn-add"><i class="fas fa-plus-circle"></i> Ajouter une carte</a>
      {% endif %}
    </div>

    <div id="cartesContainer" class="cartes-container">
      {% for carte in cartes %}
      <div class="carte" data-id="{{ carte.id }}">
        <!-- Barre d'actions -->
        <div class="carte-actions">
          <a href="{% url 'marches:voir_carte' carte.id %}" class="btn-act" title="Voir"><i class="fas fa-eye"></i></a>
          {% if request.user.profile.est_responsable %}
          <a href="{% url 'marches:modifier_carte' carte.id %}" class="btn-act mod" title="Modifier"><i class="fas fa-edit"></i></a>
          <a href="{% url 'marches:supprimer_carte' carte.id %}" class="btn-act del" title="Supprimer" onclick="return confirm('Supprimer cette carte ?');"><i class="fas fa-trash"></i></a>
          {% endif %}
        </div>

        <!-- Vue compacte (ligne) -->
        <div class="carte-compact">
          <span class="cc-titre">{{ carte.titre }}</span>
          <span class="cc-objet">{{ carte.objet|default:"-" }}</span>
          <span class="cc-client">{{ carte.nom_client|default:"-" }}</span>
          <span class="cc-date"><i class="far fa-calendar"></i> {{ carte.date_retour|date:"d/m/Y" }}</span>
        </div>

        <!-- Vue normale (carte complète) -->
        <div class="carte-normal">
          <div class="carte-header"><h4>{{ carte.titre }}</h4><button class="btn-copy" data-contenu="{{ carte.contenu|striptags|escape }}" title="Copier"><i class="far fa-copy"></i></button></div>
          <div class="carte-body">
            {% if carte.objet %}<p class="objet"><strong>Objet :</strong> {{ carte.objet }}</p>{% endif %}
            {% if carte.nom_client %}<p class="client"><strong>Client :</strong> {{ carte.nom_client }}</p>{% endif %}
            <div class="contenu">{{ carte.contenu|linebreaks }}</div>
          </div>
          {% if carte.image %}<div class="carte-image"><img src="{{ carte.image.url }}" alt="{{ carte.titre }}" loading="lazy"></div>{% endif %}
          <div class="carte-footer"><span class="date-retour"><i class="far fa-calendar"></i> Retour : {{ carte.date_retour|date:"d/m/Y" }}</span></div>
        </div>
      </div>
      {% empty %}
      <p class="empty-cartes">Aucune carte pour ce marché.</p>
      {% endfor %}
    </div>
  </section>
</main>

<script src="{% static 'marches/js/description.js' %}"></script>
{% endblock %}