{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ titre }} carte – {{ marche.nom_marche }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'marches/css/carte_form.css' %}">
  <style>
    .clients-checkboxes{display:flex;flex-direction:column;gap:.5rem}
    .checkbox-item{display:flex;align-items:center;gap:.4rem}
    .demarche-fields{display:none;margin-top:1rem}
  </style>
{% endblock %}

{% block content %}
<section class="form-hero">
  <h1><i class="fas fa-layer-group"></i> {{ titre }} une carte</h1>
  <p class="breadcrumb">
    <a href="{% url 'dashboard:dashboard' %}">Dashboard</a> /
    <a href="{% url 'marches:description' marche.id %}">{{ marche.nom_marche }}</a> /
    {{ titre }} carte
  </p>
</section>

<form method="post" enctype="multipart/form-data" class="glass-form" id="carteForm">
  {% csrf_token %}

  {% for field in form %}
    <div class="field-box">
      {{ field.label_tag }}
      {{ field }}
      {% if field.errors %}<small class="error">{{ field.errors|first }}</small>{% endif %}
    </div>
  {% endfor %}

  {# Choix des clients liés au marché #}
  <div class="field-box">
    <label>Client(s) lié(s) au marché</label>
    <div class="clients-checkboxes">
      {% for client in clients_marche %}
        <label class="checkbox-item">
          <input type="checkbox" name="clients_choisis" value="{{ client.id }}"
               {% if clients_marche|length == 1 %}checked{% endif %}>
          {{ client.nom }}
        </label>
      {% empty %}
        <p class="text-muted">Aucun client défini pour ce marché.</p>
      {% endfor %}
    </div>
  </div>

  {# Champs supplémentaires conditionnels #}
  <div class="demarche-fields" id="demarcheFields">
    <div class="field-box">
      <label for="id_demarche_solution">Démarche solution</label>
      <textarea name="demarche_solution" id="id_demarche_solution" rows="3"></textarea>
    </div>
    <div class="field-box">
      <label for="id_nom_dossier">Nom dossier</label>
      <input type="text" name="nom_dossier" id="id_nom_dossier">
    </div>
    <div class="field-box">
      <label for="id_date_livraison">Date livraison</label>
      <input type="date" name="date_livraison" id="id_date_livraison">
    </div>
  </div>

  <div class="actions">
    <a href="{% url 'marches:description' marche.id %}" class="btn-cancel">Annuler</a>
    <button type="submit" class="btn-save"><i class="fas fa-save"></i> Enregistrer</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
  <script>
    const solutionSelect = document.querySelector('#id_solution');
    const demarcheDiv = document.querySelector('#demarcheFields');

    function toggleDemarche() {
      const selected = solutionSelect.options[solutionSelect.selectedIndex];
      const need = selected && selected.dataset.demande === 'True';
      demarcheDiv.style.display = need ? 'block' : 'none';
    }

    // injection data-attribute côté serveur
    {% for sol in form.solution.field.queryset %}
      solutionSelect.querySelector('option[value="{{ sol.id }}"]').dataset.demande = '{{ sol.demande_demarche|yesno:"True,False" }}';
    {% endfor %}

    solutionSelect.addEventListener('change', toggleDemarche);
    document.addEventListener('DOMContentLoaded', toggleDemarche);
  </script>
{% endblock %}